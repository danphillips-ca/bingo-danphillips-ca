<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Game</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .bingo-card {
            border: 1px solid #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            width: 100px;
            text-align: center;
            margin: 5px;
            position: relative;
        }
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 5px;
            justify-content: center;
            max-width: 525px;
            margin: 0 auto; /* Center the grid horizontally */
        }
        .tile-header {
            font-weight: bold;
            align-items: flex-end;
            padding: 0;
        }
        .tile-content {
            background-color: #eee;
        }
        .tile-content.selected {
            background-color: #935900;
            color: white;
        }
        .tile-content.selected::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Bingo</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Placeholder Link 1</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Placeholder Link 2</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Bingo Game Settings
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                            <li><a class="dropdown-item" href="#" onclick="toggleFullscreen()">Toggle Fullscreen</a></li>
                            <li><a class="dropdown-item" href="#" onclick="shareGame()">Share game</a></li>
                            <li><a class="dropdown-item" href="#" onclick="reshuffleCard()">Reshuffle card</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 id="gameTitle"></h1>
        <div id="bingoGrid" class="bingo-grid"></div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="cookieModal" tabindex="-1" aria-labelledby="cookieModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cookieModalLabel">Cookies</h5>
                </div>
                <div class="modal-body">
                    This page requires a non-tracking cookie so that you can reload the same bingo card when you return to this site. You can refresh this cookie to reshuffle your card in the Bingo Card Settings menu.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to toggle fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Function to copy URL to clipboard
        function shareGame() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert("Game URL copied to clipboard!");
            }).catch(err => {
                alert("Failed to copy URL: " + err);
            });
        }

        // Function to delete cookie and reload the page
        function reshuffleCard() {
            document.cookie = "bingoGameData=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/play.html; SameSite=Strict";
            location.reload();
        }

        // Function to shuffle an array
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Function to set a cookie
        function setCookie(name, jsonObject, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            const path = "path=/play.html";
            const sameSite = "SameSite=Strict";
            const jsonStr = JSON.stringify(jsonObject);

            document.cookie = `${name}=${jsonStr}; ${expires}; ${path}; ${sameSite}`;
        }

        // Function to get a cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Function to parse URL parameters
        function getUrlParameter(name) {
            const url = new URL(window.location.href);
            const param = url.searchParams.get(name);
            return param ? decodeURIComponent(atob(param)) : null;
        }

        let gameData = null;
        const cookieData = getCookie('bingoGameData');

        if (cookieData) {
            gameData = JSON.parse(cookieData);
            initializeGame();
        } else {
            const base64Data = getUrlParameter('data');
            if (base64Data) {
                gameData = JSON.parse(base64Data);
                for (let key in gameData) {
                    if (Array.isArray(gameData[key])) {
                        shuffle(gameData[key]);
                    }
                }
                setCookie('bingoGameData', gameData, 7);
                initializeGame();
            } else {
                showModal();
            }
        }

        function initializeGame() {
            if (gameData) {
                document.getElementById('gameTitle').innerText = gameData.title;

                const bingoGrid = document.getElementById('bingoGrid');
                const keys = Object.keys(gameData).filter(key => key !== 'title' && key !== 'Free');

                // Generate the grid
                for (let row = 0; row < 6; row++) {
                    for (let col = 0; col < 5; col++) {
                        const card = document.createElement('div');
                        card.className = 'bingo-card';

                        if (row === 0) {
                            card.classList.add('tile-header');
                            card.innerText = keys[col];
                        } else {
                            card.classList.add('tile-content');
                            if (row === 3 && col === 2) {
                                const freeItems = gameData['Free'];
                                card.innerText = freeItems[Math.floor(Math.random() * freeItems.length)];
                            } else {
                                const listKey = keys[col];
                                if (gameData[listKey] && gameData[listKey][row - 1]) {
                                    card.innerText = gameData[listKey][row - 1];
                                }
                            }
                            card.addEventListener('click', () => {
                                card.classList.toggle('selected');
                            });
                        }
                        bingoGrid.appendChild(card);
                    }
                }
            }
        }

        function showModal() {
            const modal = new bootstrap.Modal(document.getElementById('cookieModal'), {
                backdrop: 'static',
                keyboard: false
            });
            modal.show();
        }
    </script>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
